{% extends "base.html" %}
{% block content %}
<h1>ЁЯй║ O-Health LLM рдРрдк / O-Health LLM App</h1>
<p>O-Health LLM рдРрдк рдореЗрдВ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИред рдЖрдк рд╣рд┐рдВрджреА рдореЗрдВ рдЕрдкрдиреЗ рд▓рдХреНрд╖рдг рдмреЛрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ рдЕрдВрдЧреНрд░реЗрдЬреА рдореЗрдВ рдЯрд╛рдЗрдк рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЖрдкрдХреЛ рдЖрдкрдХреЗ рдЗрдирдкреБрдЯ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рд╕рдВрднрд╛рд╡рд┐рдд рд░реЛрдЧ рдХреА рд╕рд┐рдлрд╛рд░рд┐рд╢реЗрдВ рдорд┐рд▓ рд╕рдХреЗрдВред / Welcome to the O-Health LLM App. You can either speak your symptoms in Hindi or type them in English to receive potential disease recommendations based on your inputs.</p>

<form id="symptomsForm" action="{{ url_for('home') }}" method="post">
    <label for="symptoms">рдЕрдкрдиреЗ рд▓рдХреНрд╖рдг рджрд░реНрдЬ рдХрд░реЗрдВ / Enter your symptoms:</label><br>
    <textarea id="symptoms" name="symptoms" rows="5" cols="50" placeholder="рдЕрдкрдирд╛ рд▓рдХреНрд╖рдг рдмреЛрд▓реЗрдВ рдпрд╛ рдЯрд╛рдЗрдк рдХрд░реЗрдВ / Speak or type your symptoms"></textarea><br>
    <button type="button" id="recordButton">ЁЯОд рдмреЛрд▓реЗрдВ / Speak</button><br><br>
    <input type="submit" value="рд▓рдХреНрд╖рдг рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ / Submit Symptoms">
</form>

{% if error %}
<p style="color:red;">{{ error }}</p>
{% endif %}

<!-- Include a status message area -->
<p id="statusMessage"></p>

<script>
// Function to initialize audio recording
let mediaRecorder;
let audioChunks = [];

document.getElementById('recordButton').addEventListener('click', function() {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        // Stop recording
        mediaRecorder.stop();
        this.textContent = "ЁЯОд рдмреЛрд▓реЗрдВ / Speak";
    } else {
        // Start recording
        startRecording();
        this.textContent = "тП╣я╕П Stop";
    }
});

function startRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            document.getElementById('statusMessage').textContent = "рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ... рдХреГрдкрдпрд╛ рдмреЛрд▓реЗрдВ / Recording... Please speak.";

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { 'type' : 'audio/wav; codecs=MS_PCM' });
                audioChunks = [];
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.controls = true;
                document.getElementById('statusMessage').innerHTML = "рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рд╕рдорд╛рдкреНрдд / Recording stopped. <br>рдЖрдкрдХрд╛ рдЯреНрд░рд╛рдВрд╕рдХреНрд░рд┐рдкреНрд╢рди рдиреАрдЪреЗ рджрд┐рдЦреЗрдЧрд╛ / Your transcription will appear below.";

                // Send the audio blob to the backend for transcription and translation
                transcribeAudio(audioBlob);
            };
        })
        .catch(error => {
            console.error("Error accessing microphone:", error);
            alert("рдорд╛рдЗрдХреНрд░реЛрдлреЛрди рдПрдХреНрд╕реЗрд╕ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрд╛ред рдХреГрдкрдпрд╛ рдЕрдиреБрдорддрд┐ рджреЗрдВ рдпрд╛ рдЕрдкрдиреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдЬрд╛рдВрдЪреЗрдВред");  // "Could not access the microphone. Please allow access or check your browser settings."
        });
}

function transcribeAudio(audioBlob) {
    const formData = new FormData();
    formData.append('audio', audioBlob, 'symptoms.wav');

    fetch('/transcribe', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.transcription) {
            // Update the textarea with the English transcription
            document.getElementById('symptoms').value = data.transcription;
        } else if (data.error) {
            alert("рдЯреНрд░рд╛рдВрд╕рдХреНрд░рд┐рдкреНрд╢рди рдореЗрдВ рддреНрд░реБрдЯрд┐: " + data.error);  // "Error in transcription: "
        }
        document.getElementById('statusMessage').textContent = "";
    })
    .catch(error => {
        console.error("Error during transcription:", error);
        alert("рдЯреНрд░рд╛рдВрд╕рдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рджреМрд░рд╛рди рдПрдХ рддреНрд░реБрдЯрд┐ рд╣реБрдИред рдХреГрдкрдпрд╛ рдкреБрди: рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред");  // "An error occurred during transcription. Please try again."
        document.getElementById('statusMessage').textContent = "";
    });
}

function speakWelcomeMessage() {
    if ('speechSynthesis' in window) {
        var msg = new SpeechSynthesisUtterance("O-Health рдРрдк рдореЗрдВ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИред рдХреГрдкрдпрд╛ рдЕрдкрдиреЗ рд▓рдХреНрд╖рдг рдмреЛрд▓реЗрдВ рдпрд╛ рдЯрд╛рдЗрдк рдХрд░реЗрдВред");
        msg.lang = 'hi-IN';  // Set language to Hindi

        // Fetch all available voices
        var voices = window.speechSynthesis.getVoices();

        // Select a human-like Hindi voice (preferably female)
        var selectedVoice = voices.find(function(voice) {
            return voice.lang === 'hi-IN' && (voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('male'));
        });

        if (selectedVoice) {
            msg.voice = selectedVoice;
        } else {
            console.warn("No suitable Hindi voice found. Using default voice.");
        }

        // Adjust speech parameters for naturalness
        msg.rate = 1;    // Normal rate
        msg.pitch = 1;   // Normal pitch
        msg.volume = 1;  // Full volume

        window.speechSynthesis.speak(msg);
    }
}

// Automatically speak the welcome message when the page loads
window.onload = function() {
    // Delay to ensure voices are loaded
    setTimeout(speakWelcomeMessage, 500);
};
</script>
{% endblock %}
